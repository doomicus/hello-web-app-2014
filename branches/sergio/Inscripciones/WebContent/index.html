<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

<link href="dataTables/jquery.dataTables.min.css" rel="stylesheet">
	<script src="dataTables/jquery.dataTables.js"></script>

</head>
<body>

<h1>Consultar Inscripciones</h1>

<input type="number" id="ano" value="" name="ano">
<input type="button" id="btn" value="consultar">

<script>

$(document).ready(function(){
	
	
	
	//mostramos un mensaje con la causa del problema
	function callback_error(XMLHttpRequest, textStatus, errorThrown)
	{
	    // en ambientes serios esto debe manejarse con mucho cuidado,
	    // aquí optamos por una solución simple
	    alert(errorThrown);
	    console.log(errorThrown);
	    
	    if(XMLHttpRequest.status==404) {
	        alert(thrownError);
	    }
	    
	}
	
	
	$('#ano').val((new Date).getFullYear());
	
	$('#btn').click( function(){
		
				//destruimos el datatable en el caso de example
				$('#example').dataTable().fnDestroy();
				
				$('#lstPersonas_wrapper').remove();
				
				$.ajax(
	            {
	                // puede ser "get" y "post"
	                type: "post",
	                // el módulo que hará la búsqueda
	                url: "inscripcion",
	                // los datos para la consulta
	                data: {ano: $('#ano').val()},	                
	                // que hacer si esto falla
	                error: callback_error,
	                // que hacer si funciona
	                success: function(result) {
						console.log(result);
						
						if ( result['response']!=0){
							
							alert(result['msg']);
							
							
						}else{
							
							//destruimos el datatable en el caso de example
							$('#example').dataTable().fnDestroy();							
						    $('#example').dataTable( {						    	
						        "aaData": result['data'],
						        "aoColumns": [
						            { "data": "id" },
						            { "data": "firstaccess" },
						            { "data": "firstname" },
						            { "data": "lastname" },
						            { "data": "email" },
						            { "data": "lastaccess" },
						            { "data": "lastlogin" }
						        ]
						    } );
						    
						  //destruimos el datatable en el caso de example
							$('#example2').dataTable().fnDestroy();							
						    $('#example2').dataTable( {						    	
						        "aaData": result['group'],
						        "aoColumns": [
									{ "data": "month" },
						            { "data": "count" }						            
						        ]
						    } );
							
													
							
							
							$('#lstPersonas_wrapper').remove();
							
							//creo la tabla en el body
							$('body').append(
									//creo la tabla
									'<table class="table" id="lstPersonas">'
								    + '<thead>'
								    + '    <tr>'
								    + '    	<th>Id</th>'
								    + '        <th>F. Inscripcion</th>'
								    + '        <th>Nombre</th>'
								    + '        <th>Apellido</th>'
								    + '        <th>Email</th>'
								    + '        <th>Ultimo Acceso</th>'
								    + '        <th>Ultimo Login</th>'						            
								    + '    </tr>'
								    + '</thead>'
								    + '<tbody>'								
								    + '</tbody>'
								    + '</table>'	
							
							);											
							
							$.each(result['data'], function(posicion, obj){							
								$('#lstPersonas tbody').append(
								
						        
						        		'<tr>' 
						        		+ '<td>' + obj.id + '</td>'
										+ '<td>' + obj.firstaccess + '</td>'
										+ '<td>' + obj.firstname + '</td>'
										+ '<td>' + obj.lastname + '</td>'
										+ '<td>' + obj.email + '@asdfasd</td>'						
										+ '<td>' + obj.lastaccess + '</td>'														
										+ '<td>' + obj.lastlogin + ' </td>'					        		
										+ '</tr>'
						        );
						    });						
							//configuramos la tabla con el datatable
							$('#lstPersonas').DataTable();
							
						}
							
							
							
							
					}
					
	                
	            }).done(function() {
					console.info('llamado AJAX');
				});

		});
	
	});
	

</script>


<table id="example" class="display" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th>id</th>
                <th>firstaccess</th>
                <th>Nombre</th>
                <th>lastname</th>
                <th>email</th>                  
                <th>lastaccess</th>
                <th>lastlogin</th>
            </tr>
        </thead>
 
        <tfoot>
            <tr>
                <th>id</th>
                <th>firstaccess</th>
                <th>Nombre</th>
                <th>lastname</th> 
				<th>email</th>               
                <th>lastaccess</th>
                <th>lastlogin</th>
            </tr>
        </tfoot>
    </table>
    
    <table id="example2" class="display" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th>Mes</th>
                <th>Count</th>                
            </tr>
        </thead>
 
        <tfoot>
            <tr>
                <th>Mes</th>
                <th>Count</th>
            </tr>
        </tfoot>
    </table>
    
</body>
</html>